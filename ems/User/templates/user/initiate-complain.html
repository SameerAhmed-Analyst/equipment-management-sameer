{% extends "user/home.html" %}
{% load static %}

{% block head %}
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://kit.fontawesome.com/a06ab02596.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="{% static 'user/css/custom.css' %}">
    <link rel="stylesheet" href="{% static 'maintenance/css/custom-complain.css' %}">
    <link rel="stylesheet" href="{% static 'User/spares.css' %}">
    <link rel="stylesheet" href="{% static 'User/complain_form.css' %}">
    <link rel="stylesheet" href="{% static 'User/home.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

{% endblock head %}


{% block title %}
    Complain Initiate
{% endblock title %}

{% block main-body %}
    <div class="form-container">
        <div class="main-title"><h1>Complain Form</h1></div>
        <form action="" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-item">
                <label for="date">Date</label>
                <input type="text" class="set-date form-content" id="date" name="date" value="" disabled>
            </div>
                <!-- <label for="complain#">Complain#</label>
                <input type="text" class="complain-number" id="complain" name="complain" disabled> -->
            <div class="form-item">            
                <label for="generated_by">Generated by</label>
                <input type="text" value="{{ user.username }}" id="generated_by" class="form-content" name="generated_by" disabled>
            </div>
            
            <div class="form-item">
            <label for="equipment">Equipment Name</label>
            <select onchange="fetchMachineCode()" class="selectors form-content" name="equipment" id="equipment" required>
                <option value="">Select a Equipment</option>
                {% for eq in equipments  %}
                    <option value="{{ eq.id }}">{{ eq.name }}</option>  
                {% endfor %}
            </select>
            </div>

            <div class="form-item">
                <label for="code">Code</label>
                <select onchange="fetchMachineHours()" class="selectors form-content" name="code" id="code" required>
                    <option value="">Select Machine Code</option>
                </select>
            </div>

            <div class="machine-hours form-item">
                <label for="machine-hours">Machine Hours</label>
                <input type="number" class="machine-hours form-content" id="machine-hours" name="machine-hours">
            </div>
            
            <div class="form-item">
                <label for="error-department">Department Tag</label>
                <select class="selectors form-content" name="error-department" id="error-department">
                    {% for department in departments %}
                      <option value="{{ department.id }}">{{department.name}}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-item">
                <label for="description">Description</label>
                <textarea name="description" id="description" class="form-content" cols="12" rows="5" required></textarea>
            </div>

            <div class="form-item">
                <label for="images" class="upload-wrapper">
                    <span class="upload-visible">Upload file</span>
                    <input type="file" id="image" class="upload-image" name="image[]">
                </label>
                
            </div>
            
            
            <button type="submit">Submit</button> 
            
            
        </form>
        
    </div>
    
    <script>
        
        date = document.querySelector('.set-date');
        const dateValue = new Date().toISOString().slice(0,16);
        date.value = dateValue;
        
        async function fetchMachineCode(){
            
            // console.log("I am here")
            const equipment = document.querySelector('#equipment').value;

            const url = `http://127.0.0.1:8000/machine-code/${equipment}`;
            try{
                const response = await fetch(url);

            if (!response.ok) {
                throw new Error (`Error in fetching data:${response.status}`);
                return;
            }

            const machineCode = await response.json();
            
            const element = document.querySelector('#code')    
            populateOptions(machineCode, element); 


            }
            catch (error){
                console.error("Error Fetching Machine data: ", error);
            }
     
        }

        async function fetchMachineHours(){

            // console.log("here we are")

            const machineId = +(document.querySelector('#code').value); 
            const url = `http://127.0.0.1:8000/machine-hours/${machineId}`

            if(!machineId){
                console.error('No Machine ID found');
                return
            }

            const response = await fetch(url);
            const machineHours = await response.json(); 

            if(!response.ok){
                throw new Error(`Error fetching Machine Hours:${response.status}`);
            }

            if(machineHours.machine_hours==null){
                // console.log(machineHours);
                const hours = document.querySelector('#machine-hours');
                hours.value = null;
                hours.placeholder = "No previous data";
            }
            else{
                // console.log("data:",machineHours )
                const hours = document.querySelector("#machine-hours");
                hours.value = machineHours.machine_hours;   
            }
            
            
        }

        async function populateOptions(jsonVals, element){
            //remove existing populated elements
            if (element.childNodes.length){
                while(element.firstChild){
                    element.removeChild(element.firstChild);
                }
                const option = document.createElement('option')
                option.text = "Select a machine"
                element.append(option) 
            }

            if(jsonVals.length==0){
               const optionElement = document.createElement('option');
               optionElement.value = '#';
               optionElement.text = 'No Machines';
               element.append(optionElement)
               return
            }
            else {
                let options = []

                Object.entries(jsonVals).forEach(([key, value])=>{
                // console.log(value)
                const optionElement = document.createElement('option');
                optionElement.value = value.id;
                optionElement.text = value.name;
                options.push(optionElement);
            });

            // console.log(options)
            
            element.append(...options);
            }
            


            
        }


        
    </script>
{% endblock main-body %}